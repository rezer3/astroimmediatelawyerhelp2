
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <base href="/legalform/">
    <title>ILH</title>

    <link rel="icon" href="/favicon.ico" type="image/x-icon">

      <!-- Turnstile -->
    <script
      src="https://challenges.cloudflare.com/turnstile/v0/api.js"
      async
      defer
    ></script>
<!-- Phone validation (offline, free) -->
<script src="https://unpkg.com/libphonenumber-js@1.12.15/bundle/libphonenumber-min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;500;600&family=Source+Serif+4:wght@600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="assets/ui.css">
    <style>
      :root{
        --bg: #f5f7fb;
        --tile: #ffffff;
        --ink: #0f172a;
        --muted: #64748b;
        --border: #e5e7eb;
        --blue: #1f5bd8;
        --green: #22c55e;
        --shadow: 0 10px 30px rgba(2,6,23,0.08);
        --radius: 10px;
        --inputW: 560px;
        --progress: #d97706;   /* amber-600 */
        --progressGlow: rgba(217,119,6,0.18);
      }
      

      *{ box-sizing:border-box; }
      html, body {
  overflow-x: hidden;
  width: 100%;
}
/* Step swap animation helpers */
#content {
  position: relative;
  will-change: opacity, transform;
}

#content.isTransitioning {
  pointer-events: none; /* prevent double-clicks during swap */
}
.quoteIdFooter{
  margin-top: 14px;
  color: #94a3b8;
  font-size: 12px;
  font-weight: 700;
}
      body{
        margin:0;
        font-family: var(--font-ui);
        background: var(--bg);
        color: var(--ink);
      }

      .topbar{
        height:64px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0 22px;
      }
      .brand{
        display:flex;
        align-items:center;
        gap:10px;
        font-weight:700;
      }
      .brandMark{
        width:26px;
        height:26px;
        border-radius:7px;
        background:#0b1220;
        color:#fff;
        display:grid;
        place-items:center;
        font-size:12px;
        font-weight:800;
      }
      .topRight{
        display:flex;
        align-items:center;
        gap:14px;
        color: var(--muted);
        font-weight:600;
        font-size:13px;
      }
      .phonePill{
        display:flex;
        align-items:center;
        gap:8px;
        border:1px solid var(--border);
        background:#fff;
        padding:8px 12px;
        border-radius:999px;
        color:#0f172a;
        font-weight:700;
      }
      .phonePill img{
        width:16px;
        height:16px;
        display:block;
      }

      .wrap{
        max-width: 1040px;
        margin: 0 auto;
        padding: 14px 18px 28px;
      }
      .tile{
        width: min(980px, 100%);
        margin: 18px auto 0;
        background: var(--tile);
        border: 1px solid rgba(15,23,42,0.08);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 28px 24px 18px;
         position: relative;
         z-index: 10;
      }

      .progressRow{
        display:flex;
        align-items:center;
        gap:12px;
        margin-bottom: 18px;
      }
      .progressTrack{
        flex:1;
        height:8px;
        background:#e8edf6;
        border-radius:999px;
        overflow:hidden;
      }
      .progressBar{
        height:100%;
        width:0%;
        background: var(--progress);
        border-radius:999px;
        transition: width .25s ease;
      }
      .progressPct{
        width:46px;
        text-align:right;
        font-weight:700;
        color:#94a3b8;
        font-size:13px;
      }

      .topLine{
        text-align:center;
        color: var(--muted);
        font-weight:700;
        font-size:14px;
        margin: 6px 0 14px;
      }

      .socialLine{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        font-weight:800;
        color:#64748b;
        font-size:14px;
        margin: 0 0 28px;
      }
      .stateStatusText{
        font-weight: 700;
        font-size: 13.5px;
        color: #64748b; /* muted slate */
        white-space: nowrap;
      }
      .dot{
        width:9px;
        height:9px;
        border-radius:999px;
        background:  #16a34a;
        box-shadow: 0 0 0 4px rgba(22,163,74,0.15); /* subtle halo */
       }
      h1.question{
        text-align:center;
        margin: 6px 0 18px;
        font-size: 44px;
        line-height:1.1;
        letter-spacing:-0.02em;
      }

      .inputWrap{
        display:flex;
        justify-content:center;
      }
      input, .btn, .choiceGrid{
        width: min(var(--inputW), 100%);
      }

      input{
        height:56px;
        border-radius:10px;
        border: 1px solid rgba(100,116,139,0.35);
        outline:none;
        padding: 0 18px;
        font-size:18px;
        font-weight:700;
        text-align:center;
        color:#0f172a;
        background:#fff;
      }
      input::placeholder{ color:#94a3b8; font-weight:700; text-align:center; }
      input:focus{
        border-color: rgba(31,91,216,0.55);
        box-shadow: 0 0 0 4px rgba(31,91,216,0.12);
      }

      .btnRow{
        display:flex;
        justify-content:center;
        margin-top: 14px;
      }
      .btn{
        height:56px;
        border-radius:10px;
        border: 1px solid rgba(15,23,42,0.08);
        background: var(--blue);
        color:#fff;
        font-weight:900;
        font-size:16px;
        cursor:pointer;

        display:flex;
        align-items:center;
        justify-content:center;
        text-align:center;
        line-height:1;
      }
      .btn:disabled{
        opacity:.55;
        cursor:not-allowed;
      }

      .choiceGrid{
        display:grid;
        grid-template-columns: 1fr;
        gap:12px;
        margin: 0 auto;
      }
      @media (min-width: 740px){
        .choiceGrid{ grid-template-columns: 1fr 1fr; }
      }
      .choiceBtn{
        height:56px;
        border-radius:12px;
        border: 1px solid rgba(100,116,139,0.35);
        background:#fff;
        font-weight:800;
        font-size:16px;
        cursor:pointer;
        width:100%;
      }
      .choiceBtn:hover{
        border-color: rgba(31,91,216,0.55);
        box-shadow: 0 0 0 4px rgba(31,91,216,0.10);
      }
      .agentRow{
        display:flex;
        flex-direction: column;
        align-items:center;
        justify-content:center;
        gap:10px;
        margin-top: 12px;
        margin-bottom: 6px;
        color: var(--muted);
        font-weight:700;
        font-size:14px;
        text-align:center;
      }
      .agentPic{
        width:57px;
        height:57px;
        border-radius:999px;
        overflow:hidden;
        border:none;
        background:#e5e7eb;
        flex: 0 0 auto;
      }
      .agentPic img{
        width:100%;
        height:100%;
        object-fit:cover;
        display:block;
      }

      .error{
        text-align:center;
        margin-top: 10px;
        color:#dc2626;
        font-weight:800;
        display:none;
      }

      .tsWrap{
        display:flex;
        justify-content:center;
        margin-top: 14px;
        min-height: 68px;
      }

      .tcpaShort{
        width: min(var(--inputW), 100%);
        margin: 12px auto 0;
        text-align:center;
        color:#475569;
        font-weight:700;
        font-size:13px;
        line-height:1.35;
      }

      .consentBox{
        width: min(var(--inputW), 100%);
        margin: 18px auto 0;
        border: 1px solid rgba(15,23,42,0.10);
        background: #f8fafc;
        border-radius: 14px;
        padding: 14px 16px;
        color:#334155;
      }
      .consentTitle{
        font-weight:900;
        margin: 0 0 8px;
        font-size:13px;
        letter-spacing: .01em;
        text-align:center;
      }
      .consentText{
        margin:0;
        font-size:12.5px;
        line-height:1.45;
        font-weight:650;
      }

      .belowTile{
        width: min(980px, 100%);
        margin: 22px auto 0;
        text-align:center;
        position: relative;
        z-index: 1;
      }
      .legalGlyphRow{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:26px;
      margin-top: 14px;
      padding-bottom: 8px;
    }

    .legalGlyphRow svg{
      width:26px;
      height:26px;
      fill:none;
      stroke:#7c4a12;          /* brown / legal */
      stroke-width:1.5;
      opacity:0.12;            /* key: very faint */
    }
    .glyphShield{
      transform: scaleX(1.12);
      transform-origin: center;
    }
       .footerLinks{
        margin-top: 10px;
        padding-top: 12px;
        border-top: 1px solid rgba(15,23,42,0.08);
        display:flex;
        gap:18px;
        justify-content:center;
        flex-wrap:wrap;
        font-size:13px;
        font-weight:800;
      }
      .footerLinks a{
        color:#2563eb;
        text-decoration:none;
      }
      .footerLinks a:hover{ text-decoration:underline; }
 
/* ---------- Mobile polish ---------- */
@media (max-width: 640px) {
  /* keep everything from overflowing sideways */
  html, body { width: 100%; overflow-x: hidden; }

  /* page padding */
  .container, .page, main { padding-left: 16px !important; padding-right: 16px !important; }

  /* the “card” / form panel should be full-width on mobile */
  .card, .panel, .form-card, .question-card {
    width: 100% !important;
    max-width: 100% !important;
    border-radius: 16px !important;
  }

  /* headings + input sizing */
  h1, .title, .question-title { font-size: 34px !important; line-height: 1.1 !important; }
  h2, .subtitle { font-size: 16px !important; }

  input, select, textarea, button {
    width: 100% !important;
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  /* top header: stop crowding */
  header, .header, .topbar {
    flex-wrap: wrap !important;
    gap: 10px !important;
    padding-left: 12px !important;
    padding-right: 12px !important;
  }
  .header-right, .topbar-right { margin-left: 0 !important; }

  /* phone button shouldn’t push layout */
  .phone-pill, .phone, .call-button {
    width: auto !important;
    max-width: 100% !important;
    white-space: nowrap !important;
  }

  /* consent box spacing */
  .consent, .consent-box, .legal, .terms-box {
    padding: 14px !important;
    font-size: 14px !important;
    line-height: 1.4 !important;
  }
}
/* --- Suggest box: NEVER transparent --- */
#suggestBox{
  position: relative;
  background: #fff;
}

#suggestScroll{
  background: #fff;
}

#suggestBox .suggestItem{
  background: #fff;
}

/* If you want an update animation, move items but keep them opaque */
#suggestBox.isUpdating .suggestItem{
  opacity: 1;
  transform: translateY(6px);
  transition: transform .18s ease;
}

.ilfTopbar{
  position: sticky;
  top: 0;
  z-index: 1000;
  background: #f6f7fb;          /* matches your page bg */
  border-bottom: 1px solid rgba(17,24,39,.08);
}
.ilfHeaderRight{ gap: 10px; } /* slightly tighter */

.ilfPhoneBadge{
  height: 16px;
  margin-left: -6px;     /* pulls it closer to the pill */
  width: auto;
  display: block;
  opacity: .9;
}
.ilfTopbarInner{
  max-width: 1120px;
  margin: 0 auto;
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.ilfPhoneNumber{
  white-space: nowrap;
}
.ilfBrand{
  display: inline-flex;
  align-items: baseline;
  gap: 0;
  text-decoration: none;
}

.ilfBrandName{
  font-weight: 800;
  letter-spacing: -0.02em;
  font-size: 22px;
  color: #0f172a;
}

.ilfBrandDot{
  font-weight: 700;
  font-size: 22px;
  color: rgba(15,23,42,.55);
}

.ilfPhonePill{
  display: inline-flex;
  align-items: center;
  gap: 8px;  
  justify-content: center;
  padding: 10px 14px;
  border-radius: 0;
  border: none;
  background: transparent; 
  color: #0f172a;
  text-decoration: none;
  font-weight: 700;
  font-size: 14px;
  line-height: 1;
  box-shadow: none;
}

.ilfPhonePill:hover{
  background: transparent;
}
.ilfHeaderMeta{
  font-size: 12.5px;
  font-weight: 600;
  color: #6b7280;
}

.ilfSep{
  margin: 0 6px;
  color: #94a3b8;
}
.ilfHeaderRight{
  display: flex;
  align-items: center;
  gap: 14px;
}

/* Mobile: tuck it under the brand */
@media (max-width: 640px){
  .ilfTopbarInner{
    flex-wrap: wrap;
    gap: 8px;
  }
  .ilfHeaderMeta{
    order: 3;
    width: 100%;
    text-align: center;
  }
}
#typeHint{
  position:absolute;
  left:0;
  right:0;
  top:0;
  height:56px;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  color:#94a3b8;          /* same gray as placeholder */
  font-weight:700;
  font-size:18px;
}

#typeHint .caret{
  display:inline-block;
  width:1ch;
  margin-left:2px;
  animation: typehintBlink 1s steps(1) infinite;
  opacity:.8;
}

@keyframes typehintBlink{
  50%{ opacity:0; }
}
/* Suggestion: category / credential line */
.suggestCategory {
  font-family: var(--font-authority);
  font-size: 13px;
  font-weight: 200;
  letter-spacing: 0.01em;
  color: #7c4a12; /* legal brown */
}

/* Optional: slightly darker on hover for clarity */
.suggestItem:hover .suggestCategory {
  color: #475569; /* slate-600 */
}
</style>

<script>
    
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17807584395');
</script>
  </head>

  <body>
<header class="ilfTopbar" role="banner">
  <div class="ilfTopbarInner">
    <a class="ilfBrand" href="/">
      <span class="ilfBrandName">ImmediateLawyerHelp</span><span class="ilfBrandDot">.com</span>
    </a>

<div class="ilfHeaderRight">
  <div class="ilfHeaderMeta">
    Across practice areas <span class="ilfSep">•</span> Routed by issue
  </div>
<a class="ilfPhonePill" href="tel:+16178558328">
  <img
    class="ilfPhoneBadge"
    src="assets/phone.png"
    alt=""
    aria-hidden="true" />
  <span class="ilfPhoneNumber">1-617-855-8328</span>
</a>

 
</div>
</header>

    <div class="wrap">
      <div class="tile">
        <div class="progressRow">
          <div class="progressTrack"><div id="progressBar" class="progressBar"></div></div>
          <div id="progressPct" class="progressPct">0%</div>
        </div>

        <div id="topLine" class="topLine">
          Answer a few questions so we can understand your issue.
        </div>

        <div id="socialLine" class="socialLine" style="display:none;">
        <span class="dot"></span>
        <span id="stateStatusText" class="stateStatusText"></span>
      </div>

        <h1 id="question" class="question">What’s your ZIP?</h1>

        <div id="content"></div>
        <div id="error" class="error">Enter a valid value.</div>
      </div>

      <div class="belowTile">
      <div class="legalGlyphRow" aria-hidden="true">
          <!-- Lock -->
          <svg viewBox="0 0 24 24"><path d="M7 11V8a5 5 0 0 1 10 0v3"/><rect x="5" y="11" width="14" height="10" rx="2"/></svg>

          <!-- Shield -->
          <svg class="glyphShield" viewBox="0 0 24 24">  <path d="M12 3l7 3v6c0 5-3.5 9-7 12-3.5-3-7-7-7-12V6l7-3z"/></svg>

          <!-- Document -->
          <svg viewBox="0 0 24 24"><path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1z"/><path d="M14 3v5h5"/></svg>

          <!-- Pen -->
          <svg viewBox="0 0 24 24"><path d="M12 20l7-7-3-3-7 7-2 5 5-2z"/><path d="M16 6l2 2"/></svg>

          <!-- Human -->
          <svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M4 21c0-4 4-7 8-7s8 3 8 7"/></svg>
        </div>

        <div class="footerLinks">
          <a href="https://greattruckinginsurance.com/privacy-policy/" id="privacyLink">Privacy Policy</a>
          <a href="https://greattruckinginsurance.com/terms-of-use/" id="tosLink">Terms of Use</a>
          <a href="https://greattruckinginsurance.com/California-Privacy-Choices/" id="caLink">California Privacy Choices</a>
        </div>
        <div id="quoteIdFooter" class="quoteIdFooter"></div>
      </div>
    </div>

    <script>
            /* =========================
         CONFIG
      ========================= */
      const TURNSTILE_SITE_KEY = "0x4AAAAAACViAvM2dBR8ADjN"; // <-- replace
      const AGENT_PHOTO = "assets/agent.png";

           // Will be loaded from /api/config (env var), but allow overrides
      const runtime = {
        smsMode: "off", // "on" | "off"
      };

      async function loadRuntimeConfig() {
        // Highest priority: ?sms=on|off
        const u = new URL(location.href);
        const qs = u.searchParams.get("sms");
        if (qs === "on" || qs === "off") {
          runtime.smsMode = qs;
          return;
        }

        // Next: localStorage override
      const ls = localStorage.getItem("sms_mode") || localStorage.getItem("smsMode");
        if (ls === "on" || ls === "off") {
          runtime.smsMode = ls;
          return;
        }

        // Finally: Cloudflare Pages env var via /api/config

        try {
          const res = await fetch("/api/config", { cache: "no-store" });
          if (!res.ok) throw new Error("config not ok");
          const data = await res.json();
          const mode = String(data?.smsMode || "").toLowerCase().trim();
          runtime.smsMode = (mode === "on") ? "on" : "off";
        } catch {
          runtime.smsMode = "off";
        }
      }
async function renderSearch(c){
  const wrap = document.createElement("div");
  wrap.className = "inputWrap";
  wrap.innerHTML = `
    <div style="width:min(var(--inputW), 100%); margin:0 auto; position:relative;">
      <input
        id="intentInput"
        autocomplete="off"
      />
      <div id="typeHint" aria-hidden="true"></div>
<div id="suggestBox" style="
  display:none;
  position:absolute;
  left:0;
  right:0;
  top: calc(56px + 8px);
  z-index:50;

  border:1px solid rgba(100,116,139,0.25);
  border-radius:12px;
  background:#fff;
  box-shadow:0 10px 20px rgba(2,6,23,0.06);
  overflow:hidden; /* important: outer clips, inner scrolls */
">
  <div id="suggestScroll" style="
    max-height:280px;
    overflow-y:auto;
    overscroll-behavior:contain;
  "></div>
</div>
  `;
  c.appendChild(wrap);

  const btnRow = document.createElement("div");
  btnRow.className = "btnRow";
  btnRow.innerHTML = `<button id="intentContinue" class="btn" type="button">Continue</button>`;
  c.appendChild(btnRow);

  c.appendChild(renderAgentLine(steps[currentIdx].agent));

  const input = document.getElementById("intentInput");
  function syncIntentAlign(){
  input.classList.toggle("hasText", !!(input.value && input.value.length));
}
syncIntentAlign();
input.addEventListener("input", syncIntentAlign);
  const box = document.getElementById("suggestBox");
  const btn = document.getElementById("intentContinue");
// ----- Typing placeholder animation -----
const TYPE_EXAMPLES = [
  "Car Accident",
 "Employment Termination",
  "Dog Bite",
 "Immigration",
  "Estate Planning",
   "Eviction",
   "Child Custody",
   "Medical Abuse",
  "Truck Accident",
  "Slip and Fall",
  "Traffic Ticket",
    "IRS Audit",
 ];

const hintEl = document.getElementById("typeHint");

let twTimer = null;
let twRunning = false;
let exIdx = 0, chIdx = 0;
let mode = "type"; // "type" | "pause" | "delete"
let stoppedByUser = false;

function twClear(){
  if (twTimer) clearTimeout(twTimer);
  twTimer = null;
}

function twRender(text){
  if (!hintEl) return;
  // Hide hint if user has typed anything
  if (input.value && input.value.length) {
    hintEl.style.display = "none";
    return;
  }
  hintEl.style.display = "flex";
  hintEl.innerHTML = `${escapeHtml(text)}<span class="caret">|</span>`;
}

function twTick(){
  if (!twRunning) return;

  // If user started typing, stop permanently for this focus session
  if (stoppedByUser || (input.value && input.value.length)) {
    twStop();
    return;
  }

  const word = TYPE_EXAMPLES[exIdx % TYPE_EXAMPLES.length];

  if (mode === "type") {
    chIdx++;
    twRender(word.slice(0, chIdx));
    if (chIdx >= word.length) {
      mode = "pause";
      twTimer = setTimeout(twTick, 1200);
      return;
    }
    twTimer = setTimeout(twTick, 73);
    return;
  }

  if (mode === "pause") {
    mode = "delete";
    twTimer = setTimeout(twTick, 320);
    return;
  }

  // delete
  chIdx--;
  twRender(word.slice(0, Math.max(0, chIdx)));
  if (chIdx <= 0) {
    exIdx++;
    mode = "type";
    twTimer = setTimeout(twTick, 300);
    return;
  }
  twTimer = setTimeout(twTick, 55);
}

function twStart(){
  if (twRunning) return;
  twRunning = true;
  stoppedByUser = false;
  exIdx = 0; chIdx = 0; mode = "type";
  twRender("");
  twTick();
}

function twStop(){
  twRunning = false;
  twClear();
  if (hintEl) hintEl.style.display = "none";
}

// Start immediately (only for empty input)
twStart();

// If user types: stop and stay stopped while there's content
input.addEventListener("input", () => {
  if (input.value && input.value.length) {
    stoppedByUser = true;
    twStop();
  } else {
    // if they clear the box, resume
    twStart();
  }
});

// Optional: if they click into the input and start typing, stop instantly
input.addEventListener("keydown", () => {
  if (!stoppedByUser) {
    stoppedByUser = true;
    twStop();
  }
});
  // Load categories asynchronously without making renderStep async
  loadPracticeAreas().then((cats) => {

    function norm(s){
      return String(s||"").toLowerCase().trim().replace(/\s+/g," ");
    }
  function updateFade(){
  const scrollEl = document.getElementById("suggestScroll");
  const hasMoreBelow =
    scrollEl.scrollTop + scrollEl.clientHeight < scrollEl.scrollHeight - 1;

}

document.getElementById("suggestScroll")
  .addEventListener("scroll", updateFade, { passive:true });
    function scoreMatch(q, text){
      if (!q) return -1;
      const t = norm(text);
      if (t === q) return 100;
      if (t.startsWith(q)) return 80;
      if (t.includes(q)) return 40;
      return -1;
    }
    function getSuggestions(qRaw){
      const q = norm(qRaw);
      if (q.length < 1) return [];
      const out = [];
      for (const cat of cats){
        const terms = Array.isArray(cat.terms) ? cat.terms : [];
        let best = scoreMatch(q, cat.label);
        for (const term of terms) best = Math.max(best, scoreMatch(q, term));
        if (best >= 0) out.push({ key: cat.key, label: cat.label, parent: cat.parent, score: best });
      }
      out.sort((a,b) => b.score - a.score);
      return out.slice(0, 6);
    }

function renderSuggestions(items){
  const scrollEl = document.getElementById("suggestScroll");
  scrollEl.innerHTML = "";

  if (!items.length) {
    const q = norm(input.value);
    if (!q.length) {
      box.style.display = "none";
      return;
    }
    // keep box open, empty
    box.style.display = "block";
    requestAnimationFrame(updateFade);
    return;
  }

  box.style.display = "block";
  // render items...

  for (const it of items){
    const b = document.createElement("button");
    b.classList.add("suggestItem");
    b.type = "button";
   b.innerHTML = `
  <span class="suggestLabel">${it.label}</span>
  <div class="suggestCategory">
    ${it.parent}
  </div>
`;
    b.style.cssText = `
      width:100%;
      text-align:left;
      padding:14px 16px;
      border:0;
      outline:0;
      background:#fff;
      font-size:15px;
      cursor:pointer;
    `;
    b.addEventListener("mouseenter", ()=>{ b.style.background = "#f8fafc"; });
    b.addEventListener("mouseleave", ()=>{ b.style.background = "#fff"; });
    b.onclick = () => pick(it);
    scrollEl.appendChild(b);
     
  }
  requestAnimationFrame(updateFade);
}
       
async function pick(it){
  state.intentText = input.value.trim();
  state.practiceAreaLabel = it.label;
  state.practiceAreaKey = it.key;

  await setQuestionsForPracticeArea(it.key);

  input.value = it.label;

  const scrollEl = document.getElementById("suggestScroll");
  scrollEl.innerHTML = "";
  box.style.display = "none";
    box.classList.remove("isUpdating");

  setError("");
}

let suggestTimer = null;
let updateSeq = 0;

input.addEventListener("input", () => {
  clearTimeout(suggestTimer);
  const seq = ++updateSeq;

  const qNow = norm(input.value);

  // 1) Pop the box immediately on first keystroke
 if (!qNow.length) {
  renderSuggestions([]);
  state.practiceAreaKey = "";
  state.practiceAreaLabel = "";
  return;
}

// do nothing here — wait for debounce to render real suggestions

  // 2) Regal latency: only update suggestions after debounce
  suggestTimer = setTimeout(() => {
    const items = getSuggestions(input.value);

    // fade out ONLY the items (your CSS does that via .isUpdating .suggestItem)
    box.classList.add("isUpdating");

    setTimeout(() => {
      if (seq !== updateSeq) return;

      renderSuggestions(items);

      requestAnimationFrame(() => {
        box.classList.remove("isUpdating");
      });

      if (items[0] && items[0].score >= 80){
        state.practiceAreaKey = items[0].key;
        state.practiceAreaLabel = items[0].label;
      } else {
        state.practiceAreaKey = "";
        state.practiceAreaLabel = "";
      }
    }, 170);
  }, 300);
});
    async function onContinue(){
      const raw = input.value.trim();
      if (!raw) return setError("Type what you need help with.");

      // If user didn’t click a suggestion, choose top match if available
      const items = getSuggestions(raw);
      const chosen = items[0] || { key: "general_legal", label: "General legal matter" };

      if (!state.practiceAreaKey){
        state.practiceAreaKey = chosen.key;
        state.practiceAreaLabel = chosen.label;
      }
      state.intentText = raw;

      // ensure QB steps are loaded even without a clicked suggestion
      await setQuestionsForPracticeArea(state.practiceAreaKey);

      next(); // goes to ZIP step
    }

    btn.addEventListener("click", onContinue);
    input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") onContinue(); });

    input.focus();
  }).catch(() => {
    // If categories fail to load, still allow typing and continuing (fallback)
    input.focus();
    btn.addEventListener("click", () => {
      const raw = input.value.trim();
      if (!raw) return setError("Type what you need help with.");
      state.intentText = raw;
      state.practiceAreaKey = "general_legal";
      state.practiceAreaLabel = "General legal matter";
      next();
    });
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter") btn.click();
    });
  });
}


      function loadConsentConfirmationOnce() {
  if (window.__ccLoaded) return;
  window.__ccLoaded = true;

  // Campaign token (DO NOT change this)
  window.xxConsentConfirmationTokenxx = "4202d714d2284b5e93af81627ca6b08a";

  var s = document.createElement("script");
  s.id = "xxConsentConfirmationxx";
  s.type = "text/javascript";
  s.async = true;
  s.src = "https://cdn.consentconfirmation.com/bundle-prod.js";
  document.head.appendChild(s);
}
      /* =========================
         STATE + STEPS
      ========================= */
      const state = {
  zip: "",
  zipState: "",
  firstName: "",
  lastName: "",
  email: "",
  phone: "",
  turnstileToken: null,
  intentText: "",
  practiceAreaKey: "",
  practiceAreaLabel: "",
  answers: null,
  qbSteps: null,
  quoteId: "",
  // used to render the inline Thank You step after submit
  thanksMode: "" // "sms" | "nosms"
      };

let PRACTICE_AREAS = [];

async function loadPracticeAreas() {
  if (PRACTICE_AREAS.length) return PRACTICE_AREAS;
  const res = await fetch("practice-areas.json", { cache: "no-store" });
  const data = await res.json();
  PRACTICE_AREAS = Array.isArray(data?.categories) ? data.categories : [];
  return PRACTICE_AREAS;
}

async function setQuestionsForPracticeArea(practiceAreaKey) {
  const bank = await loadQuestionBank();
  const entry = bank?.by_practice_area?.[practiceAreaKey];
  const steps2 = entry?.steps;

  if (!Array.isArray(steps2) || steps2.length < 2) {
    state.qbSteps = null;
    console.warn("No 2-step question bank entry for:", practiceAreaKey);
    return;
  }

  state.practiceAreaKey = practiceAreaKey;
  state.qbSteps = [steps2[0], steps2[1]];
  state.answers = {}; // reset QB answers for the new category
}

let QUESTION_BANK = null;

async function loadQuestionBank() {
  if (QUESTION_BANK) return QUESTION_BANK;
  const res = await fetch("question-bank.json", { cache: "no-store" });
  QUESTION_BANK = await res.json();
  return QUESTION_BANK;
}

    const steps = [
  { key: "search", pct: 0, question: "What do you need help with?", agent: "We’ll use this to route your request correctly.", showSocial:false },
  { key: "zip", pct: 14, question: "What’s your ZIP?", agent: "We only ask what we need.", showSocial:false },
  { key: "qb1", pct: 28, question: "", agent: "A couple quick questions so we route this correctly.", showSocial:true },
  { key: "qb2", pct: 50, question: "", agent: "Almost done.", showSocial:true },
  { key: "name", pct: 75, question: "What is your name?", agent: "Someone may reach out to help with next steps.", showSocial:true },
  { key: "email", pct: 85, question: "What’s your email?", agent: "We use email to share options and follow up. No Spam.", showSocial:true },
  { key: "phone", pct: 95, question: "What is your phone number?", agent: "Your information is secure.", showSocial:true },
  { key: "thanks", pct: 100, question: "Thanks — we got it.", agent: "", showSocial:false }
  ];

      let currentIdx = 0;
      let turnstileWidgetId = null;

      function $(id){ return document.getElementById(id); }

      function setError(msg){
        const el = $("error");
        if (!msg) { el.style.display = "none"; el.textContent = ""; return; }
        el.style.display = "block";
        el.textContent = msg;
      }

      function setProgress(pct){
        $("progressBar").style.width = `${pct}%`;
        $("progressPct").textContent = `${pct}%`;
      }
      // --- State glyph sprite helper (robust across browsers / base href) ---
  let __stateSpritePromise = null;

  function setHeaderForStep(step){
  $("question").textContent = step.question;

  // Step 0: search
  if (step.key === "search") {
    $("topLine").style.display = "none";
    $("socialLine").style.display = "none";
    return;
  }
        // Thank you: hide helper lines
      if (step.key === "thanks") {
      $("topLine").style.display = "none";
      $("socialLine").style.display = "none";
      return;
      }
  // ZIP step: keep helper text, and (if we already know the state) show the glyph too.
  if (step.key === "zip") {
    $("topLine").style.display = "block";
    $("socialLine").style.display = (state.zipState ? "flex" : "none");
    return;
  }

  // All subsequent steps: show the state glyph *above the main question* once ZIP has been resolved.
  $("topLine").style.display = "none";
  $("socialLine").style.display = (step.showSocial && state.zipState) ? "flex" : "none";
  // state glyph + badge are set during ZIP lookup
}

      function pushHistory(idx){
        const url = new URL(location.href);
        url.searchParams.set("step", String(idx));
        history.pushState({ idx }, "", url);
      }

      function replaceHistory(idx){
        const url = new URL(location.href);
        url.searchParams.set("step", String(idx));
        history.replaceState({ idx }, "", url);
      }

async function transitionRender(step) {
  const c = $("content");
  if (!c) return renderStep(step);

  // If animations aren’t supported, just swap instantly.
  if (!c.animate) return renderStep(step);

  c.classList.add("isTransitioning");

  // OUT
  let outAnim = null;
  try {
    outAnim = c.animate(
      [
        { opacity: 1, transform: "translateY(0px) scale(1)" },
        { opacity: 0, transform: "translateY(10px) scale(0.995)" }
      ],
      { duration: 140, easing: "ease", fill: "both" }
    );
    await outAnim.finished;
  } catch {}
  try { outAnim && outAnim.cancel(); } catch {}

  // Swap content
  renderStep(step);

  // IN
  let inAnim = null;
  try {
    inAnim = c.animate(
      [
        { opacity: 0, transform: "translateY(-6px) scale(0.998)" },
        { opacity: 1, transform: "translateY(0px) scale(1)" }
      ],
      { duration: 180, easing: "ease", fill: "both" }
    );
    await inAnim.finished;
  } catch {}
  try { inAnim && inAnim.cancel(); } catch {}

  // IMPORTANT: guarantee the container is fully opaque afterward
  c.style.opacity = "1";
  c.style.transform = "none";

  c.classList.remove("isTransitioning");
}

      function goTo(idx, { fromPop=false } = {}){
        currentIdx = Math.max(0, Math.min(idx, steps.length - 1));
        const step = steps[currentIdx];

        setProgress(step.pct);
        setHeaderForStep(step);
        setError("");

        transitionRender(step);

        if (!fromPop) pushHistory(currentIdx);
      }

      function next(){
        if (currentIdx < steps.length - 1) goTo(currentIdx + 1);
      }

      window.addEventListener("popstate", (e) => {
        const idx = (e.state && typeof e.state.idx === "number") ? e.state.idx : 0;
        goTo(idx, { fromPop:true });
      });

      /* =========================
         TURNSTILE
      ========================= */
      function mountTurnstile(container){
        state.turnstileToken = null;
        if (!container) return;

        container.innerHTML = `<div id="ts"></div>`;
        const slot = container.querySelector("#ts");

        function render(){
          if (!window.turnstile || !slot) return;
          if (turnstileWidgetId !== null) {
            try { window.turnstile.remove(turnstileWidgetId); } catch {}
            turnstileWidgetId = null;
          }
          turnstileWidgetId = window.turnstile.render(slot, {
            sitekey: TURNSTILE_SITE_KEY,
            callback: (token) => { state.turnstileToken = token; },
            "expired-callback": () => { state.turnstileToken = null; },
            "error-callback": () => { state.turnstileToken = null; }
          });
        }

        const t = setInterval(() => {
          if (window.turnstile) { clearInterval(t); render(); }
        }, 80);
      }

      /* =========================
         ZIP LOOKUP (zippopotam.us)
      ========================= */
      async function lookupZipState(zip){
        // US ZIP lookup; returns "Ohio" etc, or "" if unavailable
        try {
          const res = await fetch(`https://api.zippopotam.us/us/${encodeURIComponent(zip)}`, { cache: "no-store" });
          if (!res.ok) return "";
          const data = await res.json();
          const place = Array.isArray(data?.places) ? data.places[0] : null;
          return String(place?.state || "").trim();
        } catch {
          return "";
        }
      }

      /* =========================
         RENDER STEPS
      ========================= */
      function renderStep(step){
        const c = $("content");
        c.innerHTML = "";

        if (step.key === "search") return renderSearch(c);
        if (step.key === "zip") return renderZip(c);
        if (step.key === "qb1") return renderQuestionBankStep(c, 0);
        if (step.key === "qb2") return renderQuestionBankStep(c, 1);
        if (step.key === "name") return renderName(c);
        if (step.key === "email") return renderEmail(c);
        if (step.key === "phone") return renderPhone(c);
        if (step.key === "thanks") return renderThanks(c);
      }

      function renderAgentLine(text){
        const wrap = document.createElement("div");
        wrap.className = "agentRow";
        wrap.innerHTML = `
          <div class="agentPic"><img alt="agent" src="${AGENT_PHOTO}"></div>
          <div>${escapeHtml(text)}</div>
        `;
        return wrap;
      }
      function renderThanks(c){
 // keep it simple: reuse existing layout + styles
 const box = document.createElement("div");
 box.style.cssText = `width:min(var(--inputW),100%); margin:0 auto; text-align:center;`;
 
  const qid = state.quoteId || "";
   const isSms = (state.thanksMode === "sms");
 
 const headline = isSms ? "Thanks — check your phone." : "Thanks — we’ll be in touch.";
 const msg = isSms
      ? "We’re sending your link now. If you don’t see it in about a minute, tap Call."
    : "Someone will reach out shortly. If you’d like, tap Call to speak now.";
    
      // update big header text
    $("question").textContent = headline;
    
      box.innerHTML = `
      <p style="margin:0; color:var(--muted); font-weight:700; line-height:1.45;">${escapeHtml(msg)}</p>
    <div style="margin-top:14px; color:#94a3b8; font-size:12px; font-weight:800;">
      ${qid ? `Your Reference ID: ${escapeHtml(qid)}` : ``}
    </div>
      <div class="btnRow" style="margin-top:16px;">
      <a class="btn" href="tel:+16178558328" style="text-decoration:none;">Call 1-617-855-8328</a>
    </div>
    <p style="margin:14px 0 0; color:#64748b; font-size:13px; font-weight:650; line-height:1.45;">
      Message and data rates may apply for SMS. You can also call or look forward to someone reaching out soon.
    </p>
    `;
    c.appendChild(box);
      }


      function renderZip(c){
        const inputWrap = document.createElement("div");
        inputWrap.className = "inputWrap";
        inputWrap.innerHTML = `
          <input id="zipInput" inputmode="numeric" maxlength="5" placeholder="e.g., 02118" value="${escapeAttr(state.zip)}" />
        `;
        c.appendChild(inputWrap);

        const btnRow = document.createElement("div");
        btnRow.className = "btnRow";
        btnRow.innerHTML = `<button id="zipContinue" class="btn" type="button">Continue</button>`;
        c.appendChild(btnRow);

        c.appendChild(renderAgentLine(steps[currentIdx].agent));

        const zipInput = $("zipInput");
        const btn = $("zipContinue");
        zipInput.focus();

        function validateZip(z){
          return /^\d{5}$/.test(z);
        }

        async function onContinue(){
          const z = zipInput.value.trim();
          if (!validateZip(z)) return setError("Enter a 5-digit ZIP.");
   
          btn.disabled = true;
          btn.textContent = "Checking…";

          state.zip = z;
          state.zipState = await lookupZipState(z);
              const t = document.getElementById("stateStatusText");
            if (t && state.zipState) {
              t.textContent = `Currently handling requests in ${state.zipState}.`;
            }
              btn.disabled = false;
          btn.textContent = "Continue";

          next();
        }

        btn.addEventListener("click", onContinue);
        zipInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") onContinue();
        });
      }

function renderQuestionBankStep(c, qbIndex /* 0 or 1 */){
  const key = state.practiceAreaKey;
  if (!key) {
    setError("Please choose a category first.");
    return;
  }

  // state.qbSteps will be set when Search selection happens
  const stepDef = state.qbSteps?.[qbIndex];
  if (!stepDef) {
    setError("Missing questions for this category.");
    return;
  }

  // Put the question into the big header
  $("question").textContent = stepDef.question;

  if (stepDef.type === "choice") {
    const grid = document.createElement("div");
    grid.className = "choiceGrid";
    grid.innerHTML = (stepDef.options || [])
      .map(opt => `<button class="choiceBtn" type="button" data-val="${escapeAttr(opt)}">${escapeHtml(opt)}</button>`)
      .join("");
    c.appendChild(grid);
    c.appendChild(renderAgentLine(steps[currentIdx].agent));

    grid.querySelectorAll("button").forEach((b) => {
      b.addEventListener("click", () => {
        const val = b.getAttribute("data-val") || "";
        // store answer under the step key, e.g. tax_issue, notices_deadlines
        state.answers = state.answers || {};
        state.answers[stepDef.key] = val;
        next();
      });
    });
    return;
  }

  // Fallback: text input
  const inputWrap = document.createElement("div");
  inputWrap.className = "inputWrap";
  inputWrap.innerHTML = `<input id="qbInput" placeholder="Type your answer" />`;
  c.appendChild(inputWrap);

  const btnRow = document.createElement("div");
  btnRow.className = "btnRow";
  btnRow.innerHTML = `<button id="qbContinue" class="btn" type="button">Continue</button>`;
  c.appendChild(btnRow);

  c.appendChild(renderAgentLine(steps[currentIdx].agent));

  $("qbInput").focus();
  $("qbContinue").addEventListener("click", () => {
    const val = $("qbInput").value.trim();
    if (!val) return setError("Please enter an answer.");
    state.answers = state.answers || {};
    state.answers[stepDef.key] = val;
    next();
  });
}

    
      function renderName(c){
        const inputWrap = document.createElement("div");
        inputWrap.className = "inputWrap";
        inputWrap.style.flexDirection = "column";
        inputWrap.style.gap = "12px";
        inputWrap.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:12px; width:min(var(--inputW), 100%); margin:0 auto;">
            <input id="firstName" placeholder="First name" value="${escapeAttr(state.firstName)}" autocomplete="given-name" />
            <input id="lastName" placeholder="Last name" value="${escapeAttr(state.lastName)}" autocomplete="family-name" />
          </div>
        `;
        c.appendChild(inputWrap);

        const btnRow = document.createElement("div");
        btnRow.className = "btnRow";
        btnRow.innerHTML = `<button id="nameContinue" class="btn" type="button">Continue</button>`;
        c.appendChild(btnRow);

        c.appendChild(renderAgentLine(steps[currentIdx].agent));
        $("firstName").focus();

        function ok(){
          const fn = $("firstName").value.trim();
          const ln = $("lastName").value.trim();
          if (!fn || !ln) return setError("Enter first and last name.");
          state.firstName = fn; state.lastName = ln;
          next();
        }

        $("nameContinue").addEventListener("click", ok);
        $("lastName").addEventListener("keydown", (e)=>{ if(e.key==="Enter") ok(); });
        $("firstName").addEventListener("keydown", (e)=>{ if(e.key==="Enter") ok(); });
      }

      function renderEmail(c){
        const inputWrap = document.createElement("div");
        inputWrap.className = "inputWrap";
        inputWrap.innerHTML = `
          <input id="emailInput" inputmode="email" placeholder="name@email.com" value="${escapeAttr(state.email)}" autocomplete="email" />
        `;
        c.appendChild(inputWrap);

        const btnRow = document.createElement("div");
        btnRow.className = "btnRow";
        btnRow.innerHTML = `<button id="emailContinue" class="btn" type="button">Continue</button>`;
        c.appendChild(btnRow);

        c.appendChild(renderAgentLine(steps[currentIdx].agent));
        $("emailInput").focus();

        function validEmail(s){
          return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
        }

        function ok(){
          const em = $("emailInput").value.trim();
          if (!validEmail(em)) return setError("Enter a valid email.");
          state.email = em;
          next();
        }

        $("emailContinue").addEventListener("click", ok);
        $("emailInput").addEventListener("keydown", (e)=>{ if(e.key==="Enter") ok(); });
      }

      function renderPhone(c){
         loadConsentConfirmationOnce();
  const inputWrap = document.createElement("div");
  inputWrap.className = "inputWrap";
  inputWrap.innerHTML = `
    <input id="phoneInput" inputmode="tel" placeholder="(###) ###-####" value="${escapeAttr(state.phone)}" autocomplete="tel" />
  `;
  c.appendChild(inputWrap);

  const shortLine = document.createElement("div");
  shortLine.className = "tcpaShort";
  c.appendChild(shortLine);

  const btnRow = document.createElement("div");
  btnRow.className = "btnRow";
  btnRow.innerHTML = `
    <button
      id="finalBtn"
      class="btn consent-confirmation-form-submit"
      type="button"
      disabled
    >
      Get Help With My Case
    </button>
  `;
  c.appendChild(btnRow);
  
  const ts = document.createElement("div");
  ts.className = "tsWrap";
  c.appendChild(ts);
  mountTurnstile(ts);

  const box = document.createElement("div");
  box.className = "consentBox consent-confirmation-tcpa-disclosure";
  c.appendChild(box);

  c.appendChild(renderAgentLine(steps[currentIdx].agent));

  const btn = $("finalBtn");
  const phoneInput = $("phoneInput");
  phoneInput.focus();

   function setSubmitting(isSubmitting, label) {
  btn.dataset.prevText = btn.dataset.prevText || btn.textContent;
  btn.disabled = !!isSubmitting;

  if (isSubmitting) {
    btn.textContent = label || "Submitting…";
  } else {
    btn.textContent = btn.dataset.prevText || "Request My Options";
  }
}

  function parseUSPhone(raw) {
    const lib = window.libphonenumber;
    if (!lib || typeof lib.parsePhoneNumberFromString !== "function") return null;

    const p = lib.parsePhoneNumberFromString(String(raw || ""), "US");
    if (!p) return null;

    if (!p.isPossible() || !p.isValid()) return null;
    if (p.country !== "US") return null;

    const d10 = String(p.nationalNumber || "");
    if (!/^\d{10}$/.test(d10)) return null;

    // cheap junk filters
    if (
      /^(\d)\1{9}$/.test(d10) ||
      d10 === "1234567890" ||
      d10 === "0123456789" ||
      d10 === "9876543210" ||
      d10.startsWith("555")
    ) {
      return null;
    }

    return { e164: p.number, d10 };
  }

  function validateLocal() {
    const parsed = parseUSPhone(phoneInput.value);
    if (!parsed) return { ok: false, msg: "Enter a valid US phone number." };
    return { ok: true, d10: parsed.d10 };
  }

  function setUiForMode(){
    const mode = String(runtime.smsMode || "off").toLowerCase().trim(); // "on" | "off"

    if (mode === "on") {
      btn.textContent = "Get Link On Phone";
      btn.dataset.prevText = btn.textContent;
      shortLine.textContent =
        'By clicking the "Get Link On Phone" button, I provide my electronic signature, agree to the below terms and being contacted for marketing purposes. MSG & Data rates may apply. Frequency may vary. Reply HELP for help; STOP to opt-out.';
      box.innerHTML = `
        <div class="consentTitle">Consent &amp; Authorization</div>
        <p class="consentText">
          By clicking the "Get Link On Phone" button, I provide my written consent to agents or businesses to contact me for marketing/telemarketing purposes at the number I have provided above, using live operators, automated technology, artificial and/or AI generated voice or pre-recorded messages, SMS/MMS text messages, and/or emails, if applicable, even if I have previously registered the provided number on a company and/or any Federal or State Do Not Call Registry. I understand that my consent is not a condition of purchasing goods or services. I acknowledge that to be connected with product sellers that can fit my needs without providing this consent, I can call 617-855-8328.
        </p>
      `;
      return;
    }

    // mode === "off"
    btn.textContent = "Get Help With My Case";
    btn.dataset.prevText = btn.textContent;
    shortLine.textContent =
      'By clicking the "Get Help With My Case" button, I provide my electronic signature, agree to the below terms and being contacted for marketing purposes. MSG & Data rates may apply. Frequency may vary. Reply HELP for help; STOP to opt-out.';
    box.innerHTML = `
      <div class="consentTitle">Consent &amp; Authorization</div>
      <p class="consentText">
        By clicking “Get Help With My Case,” I provide my written consent to be contacted by legal assistance providers or their representatives regarding my request, at the phone number I provided above. Contact may be made using live operators, automated technology, artificial and/or AI-generated voice, pre-recorded messages, and/or email, if applicable, even if my number is listed on a federal or state Do Not Call registry. I understand that my consent is not required to obtain information or assistance, and that I may choose to explore my options without providing this consent by calling 617-855-8328.
      </p>
    `;
  }

  // enable/disable button based on local phone validity only
  function refreshButtonState(){
    if (btn.dataset.submitting === "1") return;
    const v = validateLocal();
    btn.disabled = !v.ok;
    if (v.ok) setError("");
  }

  phoneInput.addEventListener("input", () => {
    state.phone = phoneInput.value.trim();
    refreshButtonState();
  });

  phoneInput.addEventListener("keydown", (e)=>{
   if (e.key === "Enter") {
if (btn.dataset.submitting === "1") return;
     btn.click();
   }
  });

  async function handleFinal(){
      // Prevent double submit
      if (btn.dataset.submitting === "1") return;
      btn.dataset.submitting = "1";
      setSubmitting(true, "Submitting…");
      setError("");

    const v = validateLocal();
    if (!v.ok) {
    setSubmitting(false);
    btn.dataset.submitting = "0";
    return setError(v.msg);
    }


    // Turnstile is required only at submit time
    if (!state.turnstileToken) {
      setSubmitting(false);
      btn.dataset.submitting = "0";
      return setError("Please complete the verification.");
    }

// OPTION A: if SMS_MODE is off, skip /api/send-link entirely
const smsIntent = (String(runtime.smsMode || "off").toLowerCase().trim() === "on");
let j = { ok: true, sms: "skipped", lineType: "" };

if (smsIntent) {
  try {
    const res = await fetch("/api/send-link", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        phone: v.d10,
        link: window.location.href,
        turnstileToken: state.turnstileToken,
        dryRun: false
      })
    });

    j = await res.json().catch(() => null);

    if (!res.ok || !j || j.ok !== true) {
      setSubmitting(false);
      btn.dataset.submitting = "0";

      const err = String(j?.error || "");
      if (err.toLowerCase().includes("turnstile")) {
        return setError("Please complete the verification.");
      }
      return setError("Enter valid phone number.");
    }
  } catch {
      setSubmitting(false);
      btn.dataset.submitting = "0";
    return setError("Enter valid phone number.");
  }
}
   const smsWasSent = (j && j.sms === "sent");
       const smsSkippedReason =
      smsWasSent ? "" : (smsIntent ? "non_mobile" : "sms_mode_off");
      

    const leadPayload = {
      funnel: "ilh_legalform",
      quote_id: state.quoteId || "",
      zip: state.zip || "",
      state: state.zipState || "",
      firstname: state.firstName || "",
      lastname: state.lastName || "",
      email: state.email || "",
      phone: v.d10,

      // Intake context
      intent_text: state.intentText || "",
      practice_area_key: state.practiceAreaKey || "",
      practice_area_label: state.practiceAreaLabel || "",

      // Question bank answers (2-step)
      qb_answers: state.answers || {},

      phone_verified: true,
      phone_line_type: String(j.lineType || "").trim(),

      sms_intent: smsIntent,
      sms_link_sent: smsWasSent,
      sms_skipped_reason: smsSkippedReason,
      sms_link_clicked: false,
      sms_error: "",

      source_url: window.location.href,
      contact_source: "ilh_legalform",
    };

    try {
      const leadRes = await fetch("/api/lead", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(leadPayload),
      });

      if (!leadRes.ok) {
      setSubmitting(false);
      btn.dataset.submitting = "0";
        return setError("Lead submit failed.");
      }
    } catch {
      setSubmitting(false);
      btn.dataset.submitting = "0";
      return setError("Lead submit failed.");
    }
    // success path: keep disabled to prevent resubmit
    setSubmitting(true, "Submitted");
    // then proceed to your Thank You step/navigation as you already do

    // Inline Thank You step (no redirect)
 
      state.thanksMode = smsWasSent ? "sms" : "nosms";
      const thanksIdx = steps.findIndex(s => s.key === "thanks");
      if (thanksIdx >= 0) {
      currentIdx = thanksIdx;
      replaceHistory(thanksIdx);   // <-- key line
      setProgress(100);
      setHeaderForStep(steps[thanksIdx]);
      transitionRender(steps[thanksIdx]);
      }

  }

  btn.addEventListener("click", handleFinal);

  // init UI
  setUiForMode();
  refreshButtonState();
}
      function escapeHtml(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function escapeAttr(s){
        return escapeHtml(s).replaceAll("\n"," ");
      }


     const QUOTE_ID_KEY = "ilh_legalform_file_id";

function generateQuoteId(){
  const d = new Date();
  const yy = String(d.getFullYear()).slice(-2);
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const dd = String(d.getDate()).padStart(2, "0");
  const ymd = `${yy}${mm}${dd}`;

  const n = crypto.getRandomValues(new Uint32Array(1))[0];
  const rand = (n % (36 ** 6)).toString(36).toUpperCase().padStart(6, "0");

  return `L-${ymd}-${rand}`;
}

function getOrCreateQuoteId(){
  let qid = sessionStorage.getItem(QUOTE_ID_KEY);
  if (!qid) {
    qid = generateQuoteId();
    sessionStorage.setItem(QUOTE_ID_KEY, qid);
  }
  return qid;
}

function renderQuoteIdFooter(qid){
  const el = document.getElementById("quoteIdFooter");
  if (el) el.textContent = `Your Reference ID: ${qid}`;
} 
      /* =========================
         INIT
      ========================= */
   (async function init(){
  await loadRuntimeConfig();

  state.quoteId = getOrCreateQuoteId();
renderQuoteIdFooter(state.quoteId);
  const u = new URL(location.href);

  // 1) Optional: accept ZIP passed from landing page
  const zipFromQs = (u.searchParams.get("zip") || "").trim();
  const hasValidZip = /^\d{5}$/.test(zipFromQs);

  if (hasValidZip) {
    state.zip = zipFromQs;

    u.searchParams.set("step", "1");
    history.replaceState({ idx: 1 }, "", u.toString());
    replaceHistory(1);
    goTo(1);
    return;
  }

  // 2) Default behavior (no ZIP passed)
  const idx = Math.max(
    0,
    Math.min(parseInt(u.searchParams.get("step") || "0", 10) || 0, steps.length - 1)
  );
  replaceHistory(idx);
  goTo(idx);
})();

    </script>
    </body>
</html>